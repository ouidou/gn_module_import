<div class=container>
    <stepper [step]=2></stepper>
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0"> Mapping des champs </h5>
        </div>
        <div class="card-body" *ngIf="formReady">
            <!-- Choix du mapping -->
            <form [formGroup]="fieldMappingForm" class="was-validated">
                <fieldset>
                    <legend class="px-1">
                        Choix du mapping
                    </legend>
                    <div *ngIf="userFieldMappings" class="form-group">
                        <select class="form-control form-control-sm" id="mappingSelection"
                            formControlName="fieldMapping">
                            <option [value]=""></option>
                            <option *ngFor="let data of userFieldMappings" [value]="data.id_mapping">
                                {{data.mapping_label}}</option>
                        </select>
                    </div>
                    <div class="d-flex flex-row justify-content-between mb-3">
                        <button
                            class="btn btn-secondary btn-sm box-shadow d-flex justify-content-center align-content-between"
                            (click)="createMapping()">
                            Nouveau mapping
                        </button>
                        <button
                            class="btn btn-secondary btn-sm box-shadow d-flex justify-content-center align-content-between"
                            (click)="renameMapping()"
                            [disabled]="canUpdateMapping() || fieldMappingForm.get('fieldMapping').value === '' || fieldMappingForm.get('fieldMapping').value == null">
                            Modifier nom mapping
                        </button>
                    </div>
                    <div *ngIf="updateMapping" class="d-flex flex-row justify-content-between form_group" id="updateMap">
                        <input type="text" class="form-control mr-2" value="Inconnu" formControlName="mappingName">
                        <button
                            class="btn btn-success box-shadow d-flex justify-content-center align-content-between mr-2"
                            (click)="updateMappingName(fieldMappingForm.value, importId, syntheseForm)"
                            [disabled]="fieldMappingForm.get('mappingName').value === '' || fieldMappingForm.get('mappingName').value == null">
                            ok
                        </button>
                        <button class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                            (click)="cancelMapping()">
                            annuler
                        </button>
                    </div>
                    <div *ngIf="newMapping" class="d-flex flex-row justify-content-between form_group" id="newMap">
                        <input type="text" class="form-control mr-2" value="Inconnu" formControlName="mappingName">
                        <button
                            class="btn btn-success box-shadow d-flex justify-content-center align-content-between mr-2"
                            (click)="saveMappingName(fieldMappingForm.value, importId, syntheseForm)"
                            [disabled]="fieldMappingForm.get('mappingName').value === '' || fieldMappingForm.get('mappingName').value == null">
                            ok
                        </button>
                        <button class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                            (click)="cancelMapping()">
                            annuler
                        </button>
                    </div>
                </fieldset>
            </form>
            <form [formGroup]="syntheseForm">
                <div *ngFor="let theme of bibRes">
                    <fieldset>
                        <legend class="px-1">
                            {{theme.theme_name}}
                        </legend>
                        <div class="row m-0">
                            <div class="col-6" *ngFor="let field of theme.fields">
                                <div *ngIf="!field.autogenerated" class="form-group">
                                    <small>{{field.fr_label}} :</small>
                                    <select class="form-control form-control-sm" id="{{field.name_field}}"
                                        placeholder="Open this select menu" formControlName="{{field.name_field}}"
                                        (change)="onSelect(id_mapping, syntheseForm)" >
                                        <option [value]=""></option>
                                        <option *ngFor="let column of columns" [class.isSelected]="column.selected"
                                            [value]="column.id">
                                            {{column.id}}
                                        </option>
                                    </select>
    
                                    <div *ngIf="field.required"
                                        [class.d-block]="syntheseForm.controls[field.name_field].hasError('required')"
                                        class="invalid-feedback">Sélectionnez
                                        {{field.name_field}}</div>
                                    <div *ngIf="field.name_field=='WKT'"> 
                                        <small>*si pas de WKT, indiquez longitude et latitude</small></div>
                                </div>
                                <div *ngIf="field.autogenerated" class="form-group">
                                    <label for="auto_check"> <small>{{field.fr_label}} :</small> </label>
                                    <input type="checkbox" id="auto_check" formControlName="{{field.name_field}}">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <br>
                <div class="d-flex flex-row justify-content-between">
                    <button class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                        (click)="onStepBack()">
                        <i class="material-icons"> navigate_before </i>
                        Précédent
                    </button>
                    <button *ngIf="n_error_lines >= 0  && mappingRes"
                        class="btn btn-warning box-shadow d-flex justify-content-center align-content-between"
                        (click)="ErrorButtonClicked()">
                        {{n_error_lines}} lignes avec erreurs
                    </button>
                    <button *ngIf="!mappingRes"
                        class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                        [disabled]="syntheseForm.invalid" (click)="onDataCleaning(syntheseForm.value, id_mapping)">
                        Valider le mapping
                    </button>
                    <button
                        class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                        [disabled]="canUpdateMapping()"
                        (click)="updateMappingField(syntheseForm.value, id_mapping)">
                        Mettre à jour le mapping
                    </button>
                    <button class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                        [disabled]="!mappingIsValidate || isFullError" (click)='onNextStep()'>
                        Suivant
                        <i class="material-icons"> navigate_next </i>
                    </button>
                </div>
            </form>
            <!-- Error list in table -->
            <br>
            <div id="dataCleaningErrorList" *ngIf="isErrorButtonClicked && mappingIsValidate && n_error_lines>0">
                <div> Attention, des erreurs ont été détectées dans le fichier : </div>
                <table>
                    <thead>
                        <tr>
                            <th class="ErrorId"> Id Erreur </th>
                            <th class="ErrorType"> Type </th>
                            <th class="ErrorDescription"> Description </th>
                            <th class="ErrorColumnName"> Nom colonne</th>
                            <th class="ErrorCount"> Nombre d'erreurs</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let error of dataCleaningErrors">
                            <td> {{error.id}} </td>
                            <td> {{error.type}} </td>
                            <td> {{error.description}} </td>
                            <td> {{error.column}} </td>
                            <td> {{error.n_errors}} </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <footer>
        <footer-stepper importId={{stepData.importId}}></footer-stepper>
    </footer>
</div>
<!-- Spinner -->
<div *ngIf="spinner" class="spinner">
    <mat-spinner class="upload-spinner" [color]="color" [diameter]="150" [strokeWidth]="12">
    </mat-spinner>
</div>